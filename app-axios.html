<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Panel con Axios | CompraVenta El Hueso</title>
  <meta name="description" content="Panel protegido usando Axios para peticiones HTTP con Supabase." />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    :root { 
      color-scheme: light dark; 
      --primary-color: #667eea;
      --secondary-color: #764ba2;
      --success-color: #28a745;
      --danger-color: #dc3545;
      --warning-color: #ffc107;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: 'Poppins', sans-serif; 
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
      padding: 20px;
      line-height: 1.6;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    header { 
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
      color: white;
      padding: 20px 30px;
      display: flex;
      gap: 15px;
      align-items: center;
      flex-wrap: wrap;
    }
    header a, header button { 
      padding: 10px 15px;
      border-radius: 10px;
      border: 2px solid rgba(255,255,255,0.3);
      background: rgba(255,255,255,0.1);
      color: white;
      cursor: pointer;
      text-decoration: none;
      font-weight: 600;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    header button:hover, header a:hover { 
      background: rgba(255,255,255,0.2);
      transform: translateY(-2px);
    }
    .content {
      padding: 30px;
    }
    h1 { 
      margin: 0 0 20px;
      color: #333;
      font-size: 2.5rem;
      display: flex;
      align-items: center;
      gap: 15px;
    }
    .description {
      background: #e3f2fd;
      padding: 15px 20px;
      border-radius: 10px;
      margin-bottom: 25px;
      border-left: 4px solid var(--primary-color);
    }
    .axios-badge {
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
      color: white;
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 0.8rem;
      font-weight: 600;
      margin-left: 10px;
    }
    .search-container {
      margin-bottom: 25px;
    }
    input[type="text"] {
      width: 100%;
      max-width: 500px;
      padding: 15px 20px;
      border: 2px solid #e0e0e0;
      border-radius: 15px;
      font-size: 16px;
      transition: border-color 0.3s;
    }
    input[type="text"]:focus {
      outline: none;
      border-color: var(--primary-color);
    }
    details { 
      margin: 20px 0;
      background: #f8f9fa;
      border-radius: 15px;
      overflow: hidden;
    }
    summary {
      padding: 20px;
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
      color: white;
      cursor: pointer;
      font-weight: 600;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .form-content {
      padding: 25px;
    }
    .row { 
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 15px 0;
    }
    input, select, textarea {
      padding: 12px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 16px;
      transition: border-color 0.3s;
      font-family: inherit;
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary-color);
    }
    button {
      padding: 12px 25px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .btn-primary {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
      color: white;
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }
    .btn-danger {
      background: var(--danger-color);
      color: white;
      padding: 8px 12px;
      font-size: 14px;
    }
    .btn-danger:hover {
      background: #c82333;
      transform: translateY(-1px);
    }
    .table-container {
      overflow-x: auto;
      margin-top: 25px;
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    table { 
      border-collapse: collapse;
      width: 100%;
      background: white;
    }
    th, td { 
      padding: 15px 12px;
      text-align: left;
      vertical-align: middle;
    }
    th {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
      color: white;
      font-weight: 600;
    }
    tr:nth-child(even) {
      background: #f8f9fa;
    }
    tr:hover {
      background: #e3f2fd;
    }
    td img { 
      border-radius: 8px;
      display: block;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .muted { 
      opacity: 0.7;
      font-size: 0.9rem;
      color: #666;
    }
    .right { text-align: right; }
    .actions { display: flex; gap: 8px; }
    .msg {
      padding: 10px 15px;
      border-radius: 8px;
      margin-top: 10px;
      font-size: 14px;
    }
    .msg.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .msg.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    @media (max-width: 768px) {
      .row { grid-template-columns: 1fr; }
      header { padding: 15px 20px; }
      .content { padding: 20px; }
      h1 { font-size: 2rem; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <a href="./index.html"><i class="fas fa-home"></i> Inicio</a>
      <a href="./auth.html"><i class="fas fa-lock"></i> Acceso</a>
      <a href="./app.html"><i class="fas fa-list"></i> Panel Supabase</a>
      <a href="./app-axios.html"><i class="fas fa-network-wired"></i> Panel Axios</a>
      <span class="muted" id="whoami"></span>
      <button id="logout" title="Cerrar sesión"><i class="fas fa-sign-out-alt"></i> Salir</button>
    </header>

    <div class="content">
      <h1>
        <i class="fas fa-car"></i> Gestión de Vehículos
        <span class="axios-badge">AXIOS</span>
      </h1>
      
      <div class="description">
        <p><strong>Panel con Axios:</strong> Esta versión usa Axios para las peticiones HTTP en lugar del cliente Supabase directo. Puedes <strong>agregar</strong> vehículos y <strong>eliminar</strong> solo los que tú hayas creado. La búsqueda funciona por marca o modelo.</p>
      </div>

      <!-- Buscador -->
      <div class="search-container">
        <input id="q" placeholder="🔍 Buscar por marca o modelo..." aria-label="Buscar por marca o modelo" />
      </div>

      <!-- Alta -->
      <details>
        <summary><i class="fas fa-plus"></i> Agregar nuevo vehículo</summary>
        <div class="form-content">
          <div class="row">
            <input id="marca" placeholder="Marca (ej: Toyota)" required />
            <input id="modelo" placeholder="Modelo (ej: Corolla)" required />
            <input id="anio" type="number" min="1990" max="2100" placeholder="Año" required />
            <input id="precio" type="number" min="0" step="1" placeholder="Precio en COP" required />
            <input id="imagen_url" placeholder="URL de imagen (opcional)" />
            <input id="descripcion" placeholder="Descripción (opcional)" />
          </div>
          <div class="actions">
            <button id="add" class="btn-primary">
              <span id="add-loading" class="loading" style="display: none;"></span>
              <i class="fas fa-save" id="add-icon"></i> Guardar vehículo
            </button>
            <div id="add-msg" class="msg" role="status"></div>
          </div>
        </div>
      </details>

      <!-- Tabla -->
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th><i class="fas fa-tag"></i> Marca</th>
              <th><i class="fas fa-car"></i> Modelo</th>
              <th><i class="fas fa-calendar"></i> Año</th>
              <th class="right"><i class="fas fa-dollar-sign"></i> Precio</th>
              <th><i class="fas fa-image"></i> Imagen</th>
              <th><i class="fas fa-cogs"></i> Acciones</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr>
              <td colspan="6" style="text-align: center; padding: 40px; color: #666;">
                <div class="loading" style="margin: 0 auto 10px;"></div>
                Cargando vehículos...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script type="module">
    import { vehiculosService } from './js/apiService.js';
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    // --- Utilidades ---
    const COP = (n)=> Number(n||0).toLocaleString('es-CO',{ style:'currency', currency:'COP', maximumFractionDigits:0 });

    // Cliente Supabase para autenticación
    const SUPABASE_URL = "https://sppzbrmslxadplopnker.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNwcHpicm1zbHhhZHBsb3Bua2VyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzU5NzQ4MDAsImV4cCI6MjA1MTU1MDgwMH0.8Q8Q8Q8Q8Q8Q8Q8Q8Q8Q8Q8Q8Q8Q8Q8Q8Q8Q8Q8Q";
    const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Función para mostrar mensajes
    function showMessage(elementId, message, isError = false) {
      const msgElement = document.getElementById(elementId);
      msgElement.textContent = message;
      msgElement.className = `msg ${isError ? 'error' : 'success'}`;
      
      setTimeout(() => {
        msgElement.textContent = '';
        msgElement.className = 'msg';
      }, 5000);
    }

    // Función para mostrar/ocultar loading
    function toggleLoading(buttonId, isLoading) {
      const button = document.getElementById(buttonId);
      const loading = document.getElementById(buttonId + '-loading');
      const icon = document.getElementById(buttonId + '-icon');
      
      if (isLoading) {
        loading.style.display = 'inline-block';
        icon.style.display = 'none';
        button.disabled = true;
      } else {
        loading.style.display = 'none';
        icon.style.display = 'inline-block';
        button.disabled = false;
      }
    }

    // --- Verificación de sesión ---
    const { data: sess } = await sb.auth.getSession();
    if (!sess.session) {
      location.href = './auth.html';
    }

    // Mostrar quién está logueado
    const { data: userData } = await sb.auth.getUser();
    document.getElementById('whoami').textContent = userData?.user?.email ? `👤 ${userData.user.email}` : '';

    // Cerrar sesión
    document.getElementById('logout').onclick = async () => {
      try {
        await sb.auth.signOut();
        location.href = './auth.html';
      } catch (error) {
        console.error('Error al cerrar sesión:', error);
        location.href = './auth.html';
      }
    };

    // --- Estado & elementos DOM ---
    const tbody = document.getElementById('tbody');
    const qInput = document.getElementById('q');
    let lastQuery = '';

    // --- Carga de datos usando Axios ---
    async function load(query='') {
      lastQuery = query;

      try {
        const { data, error } = await vehiculosService.getAll(query);
        
        if (error) { 
          showMessage('add-msg', `Error al cargar datos: ${error.message || error}`, true);
          return; 
        }

        if (!data || data.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="6" style="text-align: center; padding: 40px; color: #666;">
                <i class="fas fa-car" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                ${query ? 'No se encontraron vehículos con ese criterio de búsqueda' : 'No hay vehículos registrados aún'}
              </td>
            </tr>
          `;
          return;
        }

        tbody.innerHTML = data.map(v => `
          <tr>
            <td><strong>${v.marca || 'N/A'}</strong></td>
            <td>${v.modelo || 'N/A'}</td>
            <td>${v.anio || 'N/A'}</td>
            <td class="right"><strong>${COP(v.precio)}</strong></td>
            <td>${v.imagen_url ? `<img src="${v.imagen_url}" alt="Imagen ${v.marca} ${v.modelo}" width="90" height="60" loading="lazy" style="object-fit: cover;">` : '<span class="muted"><i class="fas fa-image"></i> Sin imagen</span>'}</td>
            <td class="actions">
              <button data-id="${v.id}" class="btn-danger del" title="Eliminar vehículo">
                <i class="fas fa-trash"></i>
              </button>
            </td>
          </tr>
        `).join('');

        // Conectar botones de eliminar
        document.querySelectorAll('.del').forEach(btn=>{
          btn.onclick = async () => {
            const id = btn.getAttribute('data-id');
            const marca = btn.closest('tr').querySelector('td:first-child').textContent;
            const modelo = btn.closest('tr').querySelector('td:nth-child(2)').textContent;
            
            if (!confirm(`¿Estás seguro de que quieres eliminar el vehículo ${marca} ${modelo}?`)) {
              return;
            }

            try {
              const { error } = await vehiculosService.delete(id);
              if (error) {
                showMessage('add-msg', `Error al eliminar: ${error.message || error}`, true);
                return;
              }
              showMessage('add-msg', 'Vehículo eliminado exitosamente ✅');
              load(lastQuery);
            } catch (err) {
              showMessage('add-msg', 'Error de conexión al eliminar', true);
            }
          };
        });

      } catch (err) {
        showMessage('add-msg', 'Error de conexión al cargar datos', true);
      }
    }

    // --- Buscador ---
    let t;
    qInput.addEventListener('input', (e)=>{
      clearTimeout(t);
      t = setTimeout(()=> load(e.target.value.trim()), 200);
    });

    // --- Alta de vehículo usando Axios ---
    document.getElementById('add').onclick = async ()=>{
      try {
        toggleLoading('add', true);
        
        const who = await sb.auth.getUser();
        const payload = {
          user_id: who?.data?.user?.id,
          marca: document.getElementById('marca').value.trim(),
          modelo: document.getElementById('modelo').value.trim(),
          anio: Number(document.getElementById('anio').value),
          precio: Number(document.getElementById('precio').value),
          imagen_url: document.getElementById('imagen_url').value.trim() || null,
          descripcion: document.getElementById('descripcion').value.trim() || null
        };

        // Validación
        if (!payload.marca || !payload.modelo || !payload.anio || isNaN(payload.precio)) {
          showMessage('add-msg', 'Por favor completa todos los campos obligatorios: marca, modelo, año y precio.', true);
          return;
        }

        if (payload.anio < 1990 || payload.anio > 2030) {
          showMessage('add-msg', 'El año debe estar entre 1990 y 2030.', true);
          return;
        }

        if (payload.precio <= 0) {
          showMessage('add-msg', 'El precio debe ser mayor a 0.', true);
          return;
        }

        if (payload.imagen_url && !isValidUrl(payload.imagen_url)) {
          showMessage('add-msg', 'Por favor ingresa una URL de imagen válida.', true);
          return;
        }

        const { data, error } = await vehiculosService.create(payload);
        if (error) {
          showMessage('add-msg', `Error al agregar vehículo: ${error.message || error}`, true);
        } else {
          showMessage('add-msg', '¡Vehículo agregado exitosamente con Axios! ✅');
          ['marca','modelo','anio','precio','imagen_url','descripcion'].forEach(id => document.getElementById(id).value = '');
          load(lastQuery);
        }
      } catch (err) {
        showMessage('add-msg', 'Error de conexión al agregar vehículo', true);
      } finally {
        toggleLoading('add', false);
      }
    };

    // Función para validar URL
    function isValidUrl(string) {
      try {
        new URL(string);
        return true;
      } catch (_) {
        return false;
      }
    }

    // Carga inicial
    load();
  </script>
</body>
</html>
