<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Panel | CompraVenta El Hueso</title>
  <meta name="description" content="Panel protegido con listado, b√∫squeda y CRUD b√°sico de veh√≠culos usando Supabase." />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    :root { 
      color-scheme: light dark; 
      --primary-color: #667eea;
      --secondary-color: #764ba2;
      --success-color: #28a745;
      --danger-color: #dc3545;
      --warning-color: #ffc107;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: 'Poppins', sans-serif; 
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
      padding: 20px;
      line-height: 1.6;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    header { 
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
      color: white;
      padding: 20px 30px;
      display: flex;
      gap: 15px;
      align-items: center;
      flex-wrap: wrap;
    }
    header a, header button { 
      padding: 10px 15px;
      border-radius: 10px;
      border: 2px solid rgba(255,255,255,0.3);
      background: rgba(255,255,255,0.1);
      color: white;
      cursor: pointer;
      text-decoration: none;
      font-weight: 600;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    header button:hover, header a:hover { 
      background: rgba(255,255,255,0.2);
      transform: translateY(-2px);
    }
    .content {
      padding: 30px;
    }
    h1 { 
      margin: 0 0 20px;
      color: #333;
      font-size: 2.5rem;
      display: flex;
      align-items: center;
      gap: 15px;
    }
    .description {
      background: #e3f2fd;
      padding: 15px 20px;
      border-radius: 10px;
      margin-bottom: 25px;
      border-left: 4px solid var(--primary-color);
    }
    .search-container {
      margin-bottom: 25px;
    }
    input[type="text"] {
      width: 100%;
      max-width: 500px;
      padding: 15px 20px;
      border: 2px solid #e0e0e0;
      border-radius: 15px;
      font-size: 16px;
      transition: border-color 0.3s;
    }
    input[type="text"]:focus {
      outline: none;
      border-color: var(--primary-color);
    }
    details { 
      margin: 20px 0;
      background: #f8f9fa;
      border-radius: 15px;
      overflow: hidden;
    }
    summary {
      padding: 20px;
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
      color: white;
      cursor: pointer;
      font-weight: 600;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .form-content {
      padding: 25px;
    }
    .row { 
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 15px 0;
    }
    input, select, textarea {
      padding: 12px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 16px;
      transition: border-color 0.3s;
      font-family: inherit;
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary-color);
    }
    button {
      padding: 12px 25px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .btn-primary {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
      color: white;
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }
    .btn-danger {
      background: var(--danger-color);
      color: white;
      padding: 8px 12px;
      font-size: 14px;
    }
    .btn-danger:hover {
      background: #c82333;
      transform: translateY(-1px);
    }
    .btn-warning {
      background: #ffc107;
      color: #212529;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s;
    }
    .btn-warning:hover {
      background: #e0a800;
      transform: translateY(-1px);
    }
    .table-container {
      overflow-x: auto;
      margin-top: 25px;
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    table { 
      border-collapse: collapse;
      width: 100%;
      background: white;
    }
    th, td { 
      padding: 15px 12px;
      text-align: left;
      vertical-align: middle;
      color: #333;
      border-bottom: 1px solid #e0e0e0;
    }
    th {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
      color: white;
      font-weight: 600;
      text-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    tr:nth-child(even) {
      background: #f8f9fa;
    }
    tr:hover {
      background: #e3f2fd;
      transform: scale(1.01);
      transition: all 0.2s ease;
    }
    td {
      font-weight: 500;
    }
    td strong {
      color: #2c3e50;
      font-weight: 700;
    }
    td img { 
      border-radius: 8px;
      display: block;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .muted { 
      opacity: 0.7;
      font-size: 0.9rem;
      color: #666;
    }
    .right { text-align: right; }
    .actions { display: flex; gap: 8px; }
    .msg {
      padding: 10px 15px;
      border-radius: 8px;
      margin-top: 10px;
      font-size: 14px;
    }
    .msg.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .msg.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    @media (max-width: 768px) {
      .row { grid-template-columns: 1fr; }
      header { padding: 15px 20px; }
      .content { padding: 20px; }
      h1 { font-size: 2rem; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <a href="./index.html"><i class="fas fa-home"></i> Inicio</a>
      <a href="./auth.html"><i class="fas fa-lock"></i> Acceso</a>
      <a href="./app.html"><i class="fas fa-list"></i> Panel</a>
      <span class="muted" id="whoami"></span>
      <button id="logout" title="Cerrar sesi√≥n"><i class="fas fa-sign-out-alt"></i> Salir</button>
    </header>

    <div class="content">
      <!-- Supabase CDN oficial compatible con GitHub Pages -->
      <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
      
      <!-- Configuraci√≥n de Supabase -->
      <script>
        // Configuraci√≥n de Supabase
        const SUPABASE_URL = 'https://sppzbrmslxadplopnker.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNwcHpicm1zbHhhZHBsb3Bua2VyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3MDYwMDEsImV4cCI6MjA3MzI4MjAwMX0.XXzfsaB052T_KuQHLjqZm3lVKfifd115lZQwIES-cTg';
        
        // Crear cliente de Supabase
        const { createClient } = supabase;
        window.sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        console.log('‚úÖ Supabase inicializado correctamente en app.html');
      </script>

      <h1><i class="fas fa-car"></i> Gesti√≥n de Veh√≠culos</h1>
      
      <div class="description">
        <p><strong>Panel protegido (RLS):</strong> Puedes <strong>agregar</strong> veh√≠culos y <strong>eliminar</strong> solo los que t√∫ hayas creado. La b√∫squeda funciona por marca o modelo.</p>
      </div>

      <!-- Buscador -->
      <div class="search-container">
        <input id="q" placeholder="üîç Buscar por marca o modelo..." aria-label="Buscar por marca o modelo" />
      </div>

      <!-- Alta -->
      <details>
        <summary><i class="fas fa-plus"></i> Agregar nuevo veh√≠culo</summary>
        <div class="form-content">
          <div class="row">
            <input id="marca" placeholder="Marca (ej: Toyota)" required />
            <input id="modelo" placeholder="Modelo (ej: Corolla)" required />
            <input id="anio" type="number" min="1990" max="2100" placeholder="A√±o" required />
            <input id="precio" type="number" min="0" step="1" placeholder="Precio en COP" required />
            <input id="imagen_url" placeholder="URL de imagen (opcional)" />
            <input id="descripcion" placeholder="Descripci√≥n (opcional)" />
          </div>
          <div class="actions">
            <button id="add" class="btn-primary"><i class="fas fa-save"></i> Guardar veh√≠culo</button>
            <div id="add-msg" class="msg" role="status"></div>
          </div>
        </div>
      </details>

      <!-- Tabla -->
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th><i class="fas fa-tag"></i> Marca</th>
              <th><i class="fas fa-car"></i> Modelo</th>
              <th><i class="fas fa-calendar"></i> A√±o</th>
              <th class="right"><i class="fas fa-dollar-sign"></i> Precio</th>
              <th><i class="fas fa-image"></i> Imagen</th>
              <th><i class="fas fa-cogs"></i> Acciones</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script type="module">
    // --- Utilidades ---
    const COP = (n)=> Number(n||0).toLocaleString('es-CO',{ style:'currency', currency:'COP', maximumFractionDigits:0 });

    // Funci√≥n para mostrar mensajes
    function showMessage(elementId, message, isError = false) {
      const msgElement = document.getElementById(elementId);
      msgElement.textContent = message;
      msgElement.className = `msg ${isError ? 'error' : 'success'}`;
      
      // Limpiar mensaje despu√©s de 5 segundos
      setTimeout(() => {
        msgElement.textContent = '';
        msgElement.className = 'msg';
      }, 5000);
    }

    // --- Funci√≥n principal async ---
    async function initApp() {
      // --- Cliente y protecci√≥n de ruta ---
      const sb = window.sb;
      if (!sb) {
        alert('No se pudo cargar Supabase. Verifica la configuraci√≥n.');
        throw new Error('Supabase client missing');
      }

      // Verificar sesi√≥n
      const { data: sess } = await sb.auth.getSession();
      if (!sess.session) {
        location.href = './auth.html';
        return;
      }

    // Mostrar qui√©n est√° logueado
    const { data: userData } = await sb.auth.getUser();
    document.getElementById('whoami').textContent = userData?.user?.email ? `üë§ ${userData.user.email}` : '';

    // Cerrar sesi√≥n
    document.getElementById('logout').onclick = async () => {
      try {
        await sb.auth.signOut();
        location.href = './auth.html';
      } catch (error) {
        console.error('Error al cerrar sesi√≥n:', error);
        location.href = './auth.html';
      }
    };

    // --- Estado & elementos DOM ---
    const tbody = document.getElementById('tbody');
    const qInput = document.getElementById('q');
    let lastQuery = '';

    // --- Carga de datos ---
    async function load(query='') {
      lastQuery = query;

      try {
        let rq = sb.from('vehiculos')
          .select('*')
          .order('created_at', { ascending:false })
          .limit(500); // por si tienes >100 sembrados

        if (query) {
          rq = sb.from('vehiculos')
            .select('*')
            .or(`marca.ilike.%${query}%,modelo.ilike.%${query}%`)
            .order('created_at', { ascending:false })
            .limit(500);
        }

        const { data, error } = await rq;
        if (error) { 
          showMessage('add-msg', `Error al cargar datos: ${error.message}`, true);
          return; 
        }

        if (!data || data.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="6" style="text-align: center; padding: 40px; color: #666;">
                <i class="fas fa-car" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                ${query ? 'No se encontraron veh√≠culos con ese criterio de b√∫squeda' : 'No hay veh√≠culos registrados a√∫n'}
              </td>
            </tr>
          `;
          return;
        }

        tbody.innerHTML = data.map(v => `
          <tr>
            <td><strong>${v.marca || 'N/A'}</strong></td>
            <td>${v.modelo || 'N/A'}</td>
            <td>${v.anio || 'N/A'}</td>
            <td class="right"><strong>${COP(v.precio)}</strong></td>
            <td>${v.imagen_url ? `<img src="${v.imagen_url}" alt="Imagen ${v.marca} ${v.modelo}" width="90" height="60" loading="lazy" style="object-fit: cover;">` : '<span class="muted"><i class="fas fa-image"></i> Sin imagen</span>'}</td>
            <td class="actions">
              <button data-id="${v.id}" class="btn-warning edit" title="Editar veh√≠culo">
                <i class="fas fa-edit"></i>
              </button>
              <button data-id="${v.id}" class="btn-danger del" title="Eliminar veh√≠culo">
                <i class="fas fa-trash"></i>
              </button>
            </td>
          </tr>
        `).join('');

        // Conectar botones de editar
        document.querySelectorAll('.edit').forEach(btn=>{
          btn.onclick = async () => {
            const id = btn.getAttribute('data-id');
            const row = btn.closest('tr');
            const marca = row.querySelector('td:first-child').textContent;
            const modelo = row.querySelector('td:nth-child(2)').textContent;
            const anio = row.querySelector('td:nth-child(3)').textContent;
            const precio = row.querySelector('td:nth-child(4)').textContent.replace(/[^\d]/g, '');
            
            // Llenar el formulario con los datos actuales
            document.getElementById('marca').value = marca;
            document.getElementById('modelo').value = modelo;
            document.getElementById('anio').value = anio;
            document.getElementById('precio').value = precio;
            
            // Cambiar el bot√≥n a modo edici√≥n
            const addBtn = document.getElementById('add');
            addBtn.innerHTML = '<i class="fas fa-save"></i> Actualizar veh√≠culo';
            addBtn.setAttribute('data-edit-id', id);
            addBtn.classList.add('editing');
            
            // Scroll al formulario
            document.querySelector('.row').scrollIntoView({ behavior: 'smooth' });
            
            showMessage('add-msg', `Editando: ${marca} ${modelo}`, false);
          };
        });

        // Conectar botones de eliminar
        document.querySelectorAll('.del').forEach(btn=>{
          btn.onclick = async () => {
            const id = btn.getAttribute('data-id');
            const marca = btn.closest('tr').querySelector('td:first-child').textContent;
            const modelo = btn.closest('tr').querySelector('td:nth-child(2)').textContent;
            
            if (!confirm(`¬øEst√°s seguro de que quieres eliminar el veh√≠culo ${marca} ${modelo}?`)) {
              return;
            }

            try {
              const { error } = await sb.from('vehiculos').delete().eq('id', id);
              if (error) {
                showMessage('add-msg', `Error al eliminar: ${error.message}`, true);
                return;
              }
              showMessage('add-msg', 'Veh√≠culo eliminado exitosamente ‚úÖ');
              load(lastQuery);
            } catch (err) {
              showMessage('add-msg', 'Error de conexi√≥n al eliminar', true);
            }
          };
        });

      } catch (err) {
        showMessage('add-msg', 'Error de conexi√≥n al cargar datos', true);
      }
    }

    // --- Buscador con peque√±a espera (anti-spam de consultas) ---
    let t;
    qInput.addEventListener('input', (e)=>{
      clearTimeout(t);
      t = setTimeout(()=> load(e.target.value.trim()), 200);
    });

    // --- Alta/Edici√≥n de veh√≠culo ---
    document.getElementById('add').onclick = async ()=>{
      try {
        const addBtn = document.getElementById('add');
        const isEditing = addBtn.classList.contains('editing');
        const editId = addBtn.getAttribute('data-edit-id');
        
        const who = await sb.auth.getUser();
        const payload = {
          marca: document.getElementById('marca').value.trim(),
          modelo: document.getElementById('modelo').value.trim(),
          anio: Number(document.getElementById('anio').value),
          precio: Number(document.getElementById('precio').value),
          imagen_url: document.getElementById('imagen_url').value.trim() || null,
          descripcion: document.getElementById('descripcion').value.trim() || null
        };

        // Solo agregar user_id si es un nuevo veh√≠culo
        if (!isEditing) {
          payload.user_id = who?.data?.user?.id;
        }

        // Validaci√≥n mejorada
        if (!payload.marca || !payload.modelo || !payload.anio || isNaN(payload.precio)) {
          showMessage('add-msg', 'Por favor completa todos los campos obligatorios: marca, modelo, a√±o y precio.', true);
          return;
        }

        if (payload.anio < 1990 || payload.anio > 2030) {
          showMessage('add-msg', 'El a√±o debe estar entre 1990 y 2030.', true);
          return;
        }

        if (payload.precio <= 0) {
          showMessage('add-msg', 'El precio debe ser mayor a 0.', true);
          return;
        }

        // Validar URL de imagen si se proporciona
        if (payload.imagen_url && !isValidUrl(payload.imagen_url)) {
          showMessage('add-msg', 'Por favor ingresa una URL de imagen v√°lida.', true);
          return;
        }

        let result;
        if (isEditing) {
          // Actualizar veh√≠culo existente
          result = await sb.from('vehiculos').update(payload).eq('id', editId);
        } else {
          // Insertar nuevo veh√≠culo
          result = await sb.from('vehiculos').insert(payload);
        }

        if (result.error) {
          showMessage('add-msg', `Error al ${isEditing ? 'actualizar' : 'agregar'} veh√≠culo: ${result.error.message}`, true);
        } else {
          showMessage('add-msg', `¬°Veh√≠culo ${isEditing ? 'actualizado' : 'agregado'} exitosamente! ‚úÖ`);
          
          // Limpiar inputs y resetear bot√≥n
          ['marca','modelo','anio','precio','imagen_url','descripcion'].forEach(id => document.getElementById(id).value = '');
          addBtn.innerHTML = '<i class="fas fa-save"></i> Guardar veh√≠culo';
          addBtn.removeAttribute('data-edit-id');
          addBtn.classList.remove('editing');
          
          load(lastQuery);
        }
      } catch (err) {
        showMessage('add-msg', `Error de conexi√≥n al ${document.getElementById('add').classList.contains('editing') ? 'actualizar' : 'agregar'} veh√≠culo`, true);
      }
    };

    // Funci√≥n para validar URL
    function isValidUrl(string) {
      try {
        new URL(string);
        return true;
      } catch (_) {
        return false;
      }
    }

    // Carga inicial
    load();
    } // Cierre de la funci√≥n initApp

    // Inicializar la aplicaci√≥n cuando se carga la p√°gina
    initApp();
  </script>
</body>
</html>
