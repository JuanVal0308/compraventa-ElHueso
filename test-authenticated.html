<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Autenticado - CompraVenta El Hueso</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; }
        .log { background: #f0f0f0; padding: 10px; margin: 10px 0; border-radius: 5px; font-family: monospace; max-height: 400px; overflow-y: auto; }
        .success { background: #e8f5e8; color: #2e7d32; }
        .error { background: #ffebee; color: #c62828; }
        .warning { background: #fff3cd; color: #856404; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #0056b3; }
        input { padding: 8px; margin: 5px; width: 200px; }
        .form-group { margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê Test Autenticado de Veh√≠culos</h1>
        <p>Este script probar√° las operaciones CRUD estando autenticado.</p>
        
        <div class="form-group">
            <h3>1. Autenticaci√≥n</h3>
            <input type="email" id="email" placeholder="Email" value="test@example.com">
            <input type="password" id="password" placeholder="Password" value="123456">
            <button onclick="login()">Iniciar Sesi√≥n</button>
            <button onclick="logout()">Cerrar Sesi√≥n</button>
        </div>
        
        <div class="form-group">
            <h3>2. Test de Veh√≠culos</h3>
            <button onclick="testCRUD()">Probar CRUD Autenticado</button>
            <button onclick="listVehicles()">Listar Veh√≠culos</button>
        </div>
        
        <div class="form-group">
            <h3>3. Agregar Veh√≠culo</h3>
            <input type="text" id="marca" placeholder="Marca" value="Toyota">
            <input type="text" id="modelo" placeholder="Modelo" value="Corolla">
            <input type="number" id="anio" placeholder="A√±o" value="2023">
            <input type="number" id="precio" placeholder="Precio" value="25000">
            <input type="text" id="descripcion" placeholder="Descripci√≥n" value="Veh√≠culo de prueba">
            <button onclick="addVehicle()">Agregar Veh√≠culo</button>
        </div>
        
        <div id="log" class="log"></div>
    </div>

    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
    
    <script>
        const SUPABASE_URL = 'https://sppzbrmslxadplopnker.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNwcHpicm1zbHhhZHBsb3Bua2VyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3MDYwMDEsImV4cCI6MjA3MzI4MjAwMX0.XXzfsaB052T_KuQHLjqZm3lVKfifd115lZQwIES-cTg';
        
        const { createClient } = supabase;
        const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            log(`üîê Intentando login con: ${email}`);
            
            try {
                const { data, error } = await sb.auth.signInWithPassword({ email, password });
                if (error) {
                    log(`‚ùå Error en login: ${error.message}`, 'error');
                } else {
                    log(`‚úÖ Login exitoso. Usuario: ${data.user?.email}`, 'success');
                    log(`üÜî User ID: ${data.user?.id}`, 'success');
                }
            } catch (err) {
                log(`‚ùå Error: ${err.message}`, 'error');
            }
        }
        
        async function logout() {
            try {
                await sb.auth.signOut();
                log('‚úÖ Sesi√≥n cerrada', 'success');
            } catch (err) {
                log(`‚ùå Error: ${err.message}`, 'error');
            }
        }
        
        async function testCRUD() {
            log('üîç Probando CRUD autenticado...');
            
            try {
                // Verificar sesi√≥n
                const { data: session } = await sb.auth.getSession();
                if (!session.session) {
                    log('‚ùå No hay sesi√≥n activa. Inicia sesi√≥n primero.', 'error');
                    return;
                }
                
                log(`‚úÖ Sesi√≥n activa: ${session.session.user.email}`, 'success');
                
                // Test CREATE
                const testVehicle = {
                    user_id: session.session.user.id,
                    marca: 'Test',
                    modelo: 'Test Model',
                    anio: 2023,
                    precio: 10000,
                    descripcion: 'Veh√≠culo de prueba autenticado'
                };
                
                const { data: insertData, error: insertError } = await sb.from('vehiculos').insert(testVehicle).select();
                
                if (insertError) {
                    log(`‚ùå Error en CREATE: ${insertError.message}`, 'error');
                    return;
                }
                
                log('‚úÖ CREATE funcionando', 'success');
                
                // Test READ
                const { data: readData, error: readError } = await sb.from('vehiculos').select('*').limit(5);
                if (readError) {
                    log(`‚ùå Error en READ: ${readError.message}`, 'error');
                } else {
                    log(`‚úÖ READ funcionando. ${readData.length} registros encontrados`, 'success');
                }
                
                // Test DELETE (eliminar el registro de prueba)
                if (insertData && insertData[0]) {
                    const { error: deleteError } = await sb.from('vehiculos').delete().eq('id', insertData[0].id);
                    if (deleteError) {
                        log(`‚ùå Error en DELETE: ${deleteError.message}`, 'error');
                    } else {
                        log('‚úÖ DELETE funcionando', 'success');
                    }
                }
                
            } catch (err) {
                log(`‚ùå Error en test CRUD: ${err.message}`, 'error');
            }
        }
        
        async function listVehicles() {
            log('üîç Listando veh√≠culos...');
            
            try {
                const { data, error } = await sb.from('vehiculos').select('*').order('created_at', { ascending: false });
                if (error) {
                    log(`‚ùå Error listando veh√≠culos: ${error.message}`, 'error');
                } else {
                    log(`‚úÖ ${data.length} veh√≠culos encontrados:`, 'success');
                    data.forEach((vehicle, index) => {
                        log(`${index + 1}. ${vehicle.marca} ${vehicle.modelo} (${vehicle.anio}) - $${vehicle.precio}`, 'success');
                    });
                }
            } catch (err) {
                log(`‚ùå Error: ${err.message}`, 'error');
            }
        }
        
        async function addVehicle() {
            const marca = document.getElementById('marca').value;
            const modelo = document.getElementById('modelo').value;
            const anio = parseInt(document.getElementById('anio').value);
            const precio = parseFloat(document.getElementById('precio').value);
            const descripcion = document.getElementById('descripcion').value;
            
            log(`üöó Agregando veh√≠culo: ${marca} ${modelo}`);
            
            try {
                // Verificar sesi√≥n
                const { data: session } = await sb.auth.getSession();
                if (!session.session) {
                    log('‚ùå No hay sesi√≥n activa. Inicia sesi√≥n primero.', 'error');
                    return;
                }
                
                const vehicleData = {
                    user_id: session.session.user.id,
                    marca: marca,
                    modelo: modelo,
                    anio: anio,
                    precio: precio,
                    descripcion: descripcion
                };
                
                const { data, error } = await sb.from('vehiculos').insert(vehicleData).select();
                
                if (error) {
                    log(`‚ùå Error agregando veh√≠culo: ${error.message}`, 'error');
                } else {
                    log(`‚úÖ Veh√≠culo agregado exitosamente: ${data[0].marca} ${data[0].modelo}`, 'success');
                }
                
            } catch (err) {
                log(`‚ùå Error: ${err.message}`, 'error');
            }
        }
        
        // Verificar sesi√≥n al cargar
        window.addEventListener('load', async () => {
            const { data: session } = await sb.auth.getSession();
            if (session.session) {
                log(`‚úÖ Sesi√≥n activa: ${session.session.user.email}`, 'success');
            } else {
                log('‚ö†Ô∏è No hay sesi√≥n activa. Inicia sesi√≥n para probar.', 'warning');
            }
        });
    </script>
</body>
</html>
